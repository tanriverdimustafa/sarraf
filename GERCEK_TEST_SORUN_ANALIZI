# GERÃ‡EK KULLANIM TESTÄ° - DETAYLI SORUN ANALÄ°ZÄ° VE Ã‡Ã–ZÃœM PLANI
## ğŸ“… Tarih: 11 AralÄ±k 2024 - KullanÄ±cÄ± Test BulgularÄ±

---

## ğŸ” TESPÄ°T EDÄ°LEN SORUNLAR (Ã–ncelik SÄ±rasÄ±na GÃ¶re)

### ğŸ”´ KRÄ°TÄ°K SORUN 1: Combobox'lar BoÅŸ Geliyor

#### 1.1 Hurda AltÄ±n Ä°ÅŸlemi
- âŒ **Party combobox** boÅŸ
- âŒ **Karat combobox** (hurda kalemleri iÃ§inde) boÅŸ

#### 1.2 Yeni AlÄ±ÅŸ Ä°ÅŸlemi
- âŒ **Party combobox** boÅŸ
- âŒ **Para birimi combobox** boÅŸ
- âŒ **Karat combobox** (Ã¼rÃ¼n satÄ±rlarÄ± iÃ§inde) boÅŸ

#### 1.3 Yeni DÃ¶viz Ä°ÅŸlemi
- âŒ **MÃ¼ÅŸteri/Party seÃ§imi** eksik (hangi mÃ¼ÅŸteri iÅŸlem yaptÄ±)

#### 1.4 Party Edit
- âŒ **Party tipi combobox** boÅŸ

### ğŸ”´ KRÄ°TÄ°K SORUN 2: Hurda AltÄ±n ile Ã–deme Logic Eksik

**Durum:** Ã–deme yÃ¶ntemi olarak "Hurda AltÄ±n" seÃ§ildiÄŸinde:
- âŒ KaÃ§ gram hurda verildiÄŸi sorulmuyor
- âŒ Hangi ayar olduÄŸu sorulmuyor
- âŒ Milyem bilgisi sorulmuyor
- âŒ HAS karÅŸÄ±lÄ±ÄŸÄ± hesaplanmÄ±yor

**Ã–rnekler:**
- "Sarrafiye'ye 50 gram 22K hurda altÄ±n Ã¶dedim"
- "1 reÅŸat altÄ±n (7.2 gram, 24K) ile Ã¶deme yaptÄ±m"

### ğŸ”´ KRÄ°TÄ°K SORUN 3: Party Balance GÃ¼ncellenmiyor

**Durum:** 
- âœ… Yeni party oluÅŸturuluyor
- âœ… SatÄ±ÅŸ yapÄ±lÄ±yor
- âœ… Tahsilat alÄ±nÄ±yor
- âŒ **AMA** party sayfasÄ±nda mÃ¼ÅŸteri borÃ§lanmÄ±yor/alacaklanmÄ±yor

**Etki:**
- Party detail sayfasÄ±nda:
  - âŒ Ä°ÅŸlemler tabÄ± boÅŸ
  - âŒ Son hareketler boÅŸ
  - âŒ Ã–demeler boÅŸ
  - âŒ Balance (bakiye) gÃ¼ncellenmiyor

---

## ğŸ”¬ TEKNÄ°K SORUN ANALÄ°ZÄ°

### SORUN 1 Analizi: Combobox'lar Neden BoÅŸ?

#### Kod Ä°ncelemesi - HurdaForm.jsx
```javascript
// Line 44-61: loadLookups fonksiyonu
const loadLookups = async () => {
  try {
    const [partiesData, karatsData, snapshotData] = await Promise.all([
      getParties(),
      getKarats(),
      getLatestPriceSnapshot(),
    ]);
    setParties(partiesData || []); // â† API'den veri geliyor mu?
    setKarats(karatsData || []);   // â† API'den veri geliyor mu?
    setPriceSnapshot(snapshotData);
  } catch (error) {
    console.error('Lookup load error:', error); // â† Console'da hata var mÄ±?
  }
};

// Line 189-200: Party combobox render
<Select value={formData.party_id} onValueChange={(value) => handleChange('party_id', value)}>
  <SelectTrigger>
    <SelectValue placeholder="Hurda kabul edilecek party" />
  </SelectTrigger>
  <SelectContent>
    {parties.map((party) => (  // â† parties array'i boÅŸ mu?
      <SelectItem key={party.id} value={party.id}>
        {party.name} ({party.id})
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

#### OlasÄ± Sebepler:
1. **API endpoint Ã§aÄŸrÄ±lmÄ±yor** â†’ Network tab'da request gÃ¶rÃ¼nÃ¼yor mu?
2. **API 401/403 dÃ¶nÃ¼yor** â†’ Token expired mÄ±?
3. **API boÅŸ array dÃ¶nÃ¼yor** â†’ Database'de data var mÄ±?
4. **State gÃ¼ncellenmiyor** â†’ React DevTools'da state dolu mu?
5. **Value type mismatch** â†’ `value={party.id}` string mi integer mÄ±?

### SORUN 2 Analizi: Hurda AltÄ±n ile Ã–deme

#### Mevcut PaymentForm Logic
```javascript
// PaymentForm.jsx - Mevcut yapÄ±
const [formData, setFormData] = useState({
  type_code: 'PAYMENT',
  party_id: '',
  transaction_date: new Date().toISOString().split('T')[0],
  currency: 'TRY',
  total_amount_currency: '', // â† TL olarak Ã¶deme tutarÄ±
  payment_method_code: '',   // â† GOLD_SCRAP seÃ§ilirse ne olmalÄ±?
  notes: '',
});

// âŒ EKSIK: GOLD_SCRAP seÃ§ildiÄŸinde:
// - weight_gram sorulmalÄ±
// - karat_id sorulmalÄ±
// - fineness hesaplanmalÄ±
// - HAS karÅŸÄ±lÄ±ÄŸÄ± hesaplanmalÄ±
```

#### OlmasÄ± Gereken Logic
```javascript
// Payment method = GOLD_SCRAP ise:
if (formData.payment_method_code === 'GOLD_SCRAP') {
  // Yeni alanlar gÃ¶ster:
  formData.scrap_lines = [
    {
      karat_id: '',
      weight_gram: '',
      fineness: '',  // karat'tan otomatik hesaplanÄ±r
      has_amount: '' // weight Ã— fineness
    }
  ];
  
  // Total HAS = sum(scrap_lines.has_amount)
  // TL karÅŸÄ±lÄ±ÄŸÄ± = Total HAS Ã— has_buy_price
}
```

### SORUN 3 Analizi: Party Balance GÃ¼ncellenmiyor

#### Backend Transaction Flow KontrolÃ¼
```python
# financial_v2_transactions.py iÃ§inde
# Her transaction create'de party balance gÃ¼ncellenmeli

async def create_sale_transaction(data, user_id, db):
    # ... transaction oluÅŸtur ...
    
    # â“ Party balance gÃ¼ncelleniyor mu?
    # Kontrol edilmesi gereken:
    
    # Option 1: Transaction'da total_has_amount var mÄ±?
    transaction_doc = {
        "total_has_amount": -150.500000,  # Negative = OUT (mÃ¼ÅŸteriden Ã§Ä±kÄ±ÅŸ)
        "party_id": "customer_uuid",
        # ...
    }
    
    # Option 2: Party balance ayrÄ± bir collection'da mÄ± tutulmalÄ±?
    # Option 3: Aggregate query ile mi hesaplanmalÄ±?
```

#### Party Detail Page API
```javascript
// PartyDetailPage.js - Line 40-47
const [partyResponse, transactionsResponse] = await Promise.all([
  axios.get(`${API}/parties/${id}`),        // â† Party bilgisi
  axios.get(`${API}/parties/${id}/transactions`) // â† Ä°ÅŸlemler
]);

// â“ Backend'de bu endpoint var mÄ±?
// GET /api/parties/{id}/transactions
// â“ Financial transactions'larÄ± getiriyor mu?
```

---

## ğŸ› ï¸ Ã‡Ã–ZÃœM PLANI (EMERGENT AI Ä°Ã‡Ä°N)

### Ã‡Ã–ZÃœM 1: Combobox'larÄ± DÃ¼zelt (1-2 saat)

#### AdÄ±m 1.1: Debug - Veri Gelmiyor mu Kontrol Et

**Dosya:** `frontend/src/components/transactions/forms/HurdaForm.jsx`

```javascript
// Line 44'e console log EKLE:
const loadLookups = async () => {
  console.log('ğŸ” HurdaForm: Loading lookups...');
  
  try {
    const [partiesData, karatsData, snapshotData] = await Promise.all([
      getParties(),
      getKarats(),
      getLatestPriceSnapshot(),
    ]);
    
    console.log('ğŸ“Š Parties data:', partiesData);
    console.log('ğŸ“Š Karats data:', karatsData);
    console.log('ğŸ“Š Snapshot data:', snapshotData);
    
    setParties(partiesData || []);
    setKarats(karatsData || []);
    setPriceSnapshot(snapshotData);
    
    console.log('âœ… State updated');
  } catch (error) {
    console.error('âŒ Lookup load error:', error);
  }
};
```

**Test Et:**
1. Hurda formunu aÃ§
2. F12 â†’ Console'a bak
3. Log'larÄ± gÃ¶r:
   - API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor mu?
   - Data geliyor mu?
   - State gÃ¼ncelleniyor mu?

#### AdÄ±m 1.2: API Token KontrolÃ¼

**Dosya:** `frontend/src/services/financialV2Service.js`

```javascript
// Her API Ã§aÄŸrÄ±sÄ±nda token var mÄ± kontrol et:
export const getParties = async () => {
  console.log('ğŸ” Token:', localStorage.getItem('token') ? 'EXISTS' : 'MISSING');
  
  const response = await api.get('/api/parties');
  
  console.log('ğŸ“¡ GET /api/parties:', response.status, response.data);
  
  return response.data;
};
```

#### AdÄ±m 1.3: Value Type Fix

**Sorun:** ID'ler string mi integer mi?

```javascript
// Combobox'larda value type'Ä± kontrol et:
<Select 
  value={formData.party_id}  // â† String mi? Number mi?
  onValueChange={(value) => {
    console.log('Selected value:', value, typeof value);
    handleChange('party_id', value);
  }}
>
  <SelectContent>
    {parties.map((party) => (
      <SelectItem 
        key={party.id} 
        value={party.id.toString()} // â† String'e Ã§evir
      >
        {party.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>

// handleChange'de:
const handleChange = (field, value) => {
  console.log(`ğŸ”„ ${field} =`, value);
  setFormData((prev) => ({ ...prev, [field]: value }));
};
```

#### AdÄ±m 1.4: AynÄ± Fix'i TÃ¼m Formlarda Uygula

**Dosyalar:**
- âœ… `PurchaseForm.jsx` (party, currency, karat combobox'larÄ±)
- âœ… `HurdaForm.jsx` (party, karat combobox'larÄ±)
- âœ… `ExchangeForm.jsx` (currency, party combobox'larÄ±)
- âœ… `PaymentForm.jsx` (party combobox'Ä±)
- âœ… `PartyFormDialog.js` (party type combobox'Ä±)

**Tek Bir Pattern:**
```javascript
// 1. useEffect'te load
useEffect(() => {
  loadLookups();
}, []);

// 2. Async function ile API Ã§aÄŸÄ±r
const loadLookups = async () => {
  try {
    const data = await getParties();
    console.log('Loaded parties:', data); // â† DEBUG
    setParties(data || []);
  } catch (error) {
    console.error('Error:', error);
    toast.error('Veriler yÃ¼klenemedi');
  }
};

// 3. Map ile render
{parties.map((party) => (
  <SelectItem key={party.id} value={party.id.toString()}>
    {party.name}
  </SelectItem>
))}
```

---

### Ã‡Ã–ZÃœM 2: Hurda AltÄ±n ile Ã–deme (2-3 saat)

#### YaklaÅŸÄ±m: PaymentForm'u GeniÅŸlet

**Dosya:** `frontend/src/components/transactions/forms/PaymentForm.jsx`

#### AdÄ±m 2.1: State'e Hurda Lines Ekle

```javascript
const [formData, setFormData] = useState({
  type_code: 'PAYMENT',
  party_id: '',
  transaction_date: new Date().toISOString().split('T')[0],
  currency: 'TRY',
  total_amount_currency: '',
  payment_method_code: '',
  notes: '',
  
  // YENÄ°: Hurda altÄ±n iÃ§in
  scrap_lines: []  // â† Hurda altÄ±n seÃ§ilirse doldurulacak
});

const [karats, setKarats] = useState([]);
const [showScrapSection, setShowScrapSection] = useState(false);
```

#### AdÄ±m 2.2: Payment Method DeÄŸiÅŸince Kontrol Et

```javascript
const handlePaymentMethodChange = (value) => {
  handleChange('payment_method_code', value);
  
  // Hurda altÄ±n seÃ§ildiyse scrap section'Ä± gÃ¶ster
  if (value === 'GOLD_SCRAP') {
    setShowScrapSection(true);
    
    // Ä°lk satÄ±rÄ± ekle
    if (formData.scrap_lines.length === 0) {
      setFormData(prev => ({
        ...prev,
        scrap_lines: [{
          karat_id: '',
          weight_gram: '',
          fineness: '',
          has_amount: '',
          note: ''
        }]
      }));
    }
  } else {
    setShowScrapSection(false);
    setFormData(prev => ({
      ...prev,
      scrap_lines: []
    }));
  }
};
```

#### AdÄ±m 2.3: Hurda Section UI Ekle

```javascript
{/* Hurda AltÄ±n DetaylarÄ± (GOLD_SCRAP seÃ§iliyse) */}
{showScrapSection && (
  <Card className="border-amber-500/20 bg-amber-50/50">
    <CardHeader>
      <CardTitle>Hurda AltÄ±n DetaylarÄ±</CardTitle>
      <CardDescription>
        Ã–deme iÃ§in kullanÄ±lan hurda altÄ±n bilgileri
      </CardDescription>
    </CardHeader>
    <CardContent className="space-y-4">
      {formData.scrap_lines.map((line, index) => (
        <div key={index} className="p-4 border rounded-lg space-y-4">
          <div className="flex items-center justify-between">
            <span className="font-semibold">Hurda #{index + 1}</span>
            {formData.scrap_lines.length > 1 && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => removeScrapLine(index)}
              >
                <Trash2 className="w-4 h-4" />
              </Button>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Karat SeÃ§imi */}
            <div className="space-y-2">
              <Label>Karat *</Label>
              <Select
                value={line.karat_id}
                onValueChange={(value) => handleScrapLineChange(index, 'karat_id', value)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ayar seÃ§iniz" />
                </SelectTrigger>
                <SelectContent>
                  {karats.map((karat) => (
                    <SelectItem key={karat.id} value={karat.id.toString()}>
                      {karat.karat}K ({karat.fineness})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* AÄŸÄ±rlÄ±k */}
            <div className="space-y-2">
              <Label>AÄŸÄ±rlÄ±k (gram) *</Label>
              <Input
                type="number"
                step="0.01"
                placeholder="10.50"
                value={line.weight_gram}
                onChange={(e) => handleScrapLineChange(index, 'weight_gram', e.target.value)}
              />
            </div>
          </div>

          {/* HAS Hesaplama GÃ¶sterimi */}
          <div className="bg-green-50 p-3 rounded-lg">
            <p className="text-sm text-green-800">
              <strong>HAS KarÅŸÄ±lÄ±ÄŸÄ±:</strong> {calculateScrapHAS(line).toFixed(6)} HAS
            </p>
            <p className="text-xs text-muted-foreground">
              {line.weight_gram} gr Ã— {line.fineness || 0} fineness
            </p>
          </div>
        </div>
      ))}

      {/* Toplam HAS */}
      <div className="bg-amber-100 p-4 rounded-lg">
        <p className="text-lg font-bold text-amber-900">
          Toplam HAS: {calculateTotalScrapHAS().toFixed(6)} HAS
        </p>
        <p className="text-sm text-amber-700">
          TL KarÅŸÄ±lÄ±ÄŸÄ±: â‚º{calculateTotalScrapTL().toFixed(2)}
        </p>
      </div>

      <Button
        type="button"
        variant="outline"
        onClick={addScrapLine}
      >
        <Plus className="w-4 h-4 mr-2" />
        Hurda Kalemi Ekle
      </Button>
    </CardContent>
  </Card>
)}
```

#### AdÄ±m 2.4: Helper Functions

```javascript
const handleScrapLineChange = (index, field, value) => {
  setFormData(prev => {
    const newLines = [...prev.scrap_lines];
    newLines[index] = { ...newLines[index], [field]: value };
    
    // Karat seÃ§ilince fineness'Ä± otomatik doldur
    if (field === 'karat_id') {
      const karat = karats.find(k => k.id.toString() === value);
      if (karat) {
        newLines[index].fineness = karat.fineness;
      }
    }
    
    return { ...prev, scrap_lines: newLines };
  });
};

const calculateScrapHAS = (line) => {
  if (!line.weight_gram || !line.fineness) return 0;
  return parseFloat(line.weight_gram) * parseFloat(line.fineness);
};

const calculateTotalScrapHAS = () => {
  return formData.scrap_lines.reduce((sum, line) => sum + calculateScrapHAS(line), 0);
};

const calculateTotalScrapTL = () => {
  if (!priceSnapshot?.has_buy_tl) return 0;
  return calculateTotalScrapHAS() * priceSnapshot.has_buy_tl;
};

const addScrapLine = () => {
  setFormData(prev => ({
    ...prev,
    scrap_lines: [
      ...prev.scrap_lines,
      {
        karat_id: '',
        weight_gram: '',
        fineness: '',
        has_amount: '',
        note: ''
      }
    ]
  }));
};

const removeScrapLine = (index) => {
  if (formData.scrap_lines.length === 1) {
    toast.error('En az bir hurda kalemi gereklidir');
    return;
  }
  setFormData(prev => ({
    ...prev,
    scrap_lines: prev.scrap_lines.filter((_, i) => i !== index)
  }));
};
```

#### AdÄ±m 2.5: Backend Payload

```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  
  // ... validation ...
  
  // Hurda altÄ±n ile Ã¶deme ise Ã¶zel payload
  let payload;
  
  if (formData.payment_method_code === 'GOLD_SCRAP') {
    payload = {
      type_code: 'PAYMENT',
      party_id: formData.party_id,
      transaction_date: formData.transaction_date,
      payment_method_code: 'GOLD_SCRAP',
      notes: formData.notes,
      
      // Hurda altÄ±n lines
      lines: formData.scrap_lines.map(line => ({
        line_kind: 'PAYMENT',
        karat_id: parseInt(line.karat_id),
        weight_gram: parseFloat(line.weight_gram),
        fineness: parseFloat(line.fineness),
        material_has: calculateScrapHAS(line),
        note: line.note || ''
      })),
      
      // Total hesaplama
      total_has_amount: -calculateTotalScrapHAS(), // Negative (OUT)
      total_amount_currency: calculateTotalScrapTL(),
      currency: 'TRY'
    };
  } else {
    // Normal para ile Ã¶deme
    payload = {
      ...formData,
      total_amount_currency: parseFloat(formData.total_amount_currency)
    };
  }
  
  console.log('ğŸ’° Payment payload:', payload);
  
  const result = await createFinancialTransaction(payload);
  // ...
};
```

---

### Ã‡Ã–ZÃœM 3: Party Balance ve Ä°ÅŸlemler (2-3 saat)

#### Sorun Analizi
1. âœ… Transaction oluÅŸturuluyor
2. âŒ Party'nin transaction'larÄ± gÃ¶rÃ¼nmÃ¼yor
3. âŒ Party balance gÃ¼ncellenmiyor

#### Backend Kontrol: Party Transactions Endpoint Var mÄ±?

**Dosya:** `backend/server.py`

```python
# Kontrol edilecek:
# GET /api/parties/{party_id}/transactions endpoint'i var mÄ±?

@api_router.get("/parties/{party_id}/transactions")
async def get_party_transactions(
    party_id: str,
    credentials: HTTPAuthorizationCredentials = Depends(security)
):
    """Get all financial transactions for a party"""
    # Financial transactions collection'dan Ã§ek
    transactions = await db.financial_transactions.find(
        {"party_id": party_id}
    ).sort("transaction_date", -1).to_list(100)
    
    return transactions

# Party balance endpoint'i var mÄ±?
@api_router.get("/parties/{party_id}/balance")
async def get_party_balance(
    party_id: str,
    credentials: HTTPAuthorizationCredentials = Depends(security)
):
    """Calculate party balance from all transactions"""
    # Aggregate query ile hesapla
    pipeline = [
        {"$match": {"party_id": party_id, "status": "COMPLETED"}},
        {"$group": {
            "_id": None,
            "total_has": {"$sum": "$total_has_amount"}
        }}
    ]
    
    result = await db.financial_transactions.aggregate(pipeline).to_list(1)
    
    if result:
        return {"balance_has": result[0]["total_has"]}
    return {"balance_has": 0.0}
```

#### AdÄ±m 3.1: Backend Endpoint Ekle (Yoksa)

**Dosya:** `backend/server.py`

```python
# Line ~1000 civarÄ±na EKLE:

@api_router.get("/parties/{party_id}/transactions")
async def get_party_transactions(
    party_id: str,
    credentials: HTTPAuthorizationCredentials = Depends(security)
):
    """
    Get all financial transactions for a specific party
    """
    verify_token(credentials.credentials)
    
    transactions = await db.financial_transactions.find(
        {"party_id": party_id}
    ).sort("transaction_date", -1).to_list(1000)
    
    # Convert ObjectId to string for JSON serialization
    for tx in transactions:
        tx["_id"] = str(tx["_id"])
        if "price_snapshot_id" in tx:
            tx["price_snapshot_id"] = str(tx["price_snapshot_id"])
        if "lines" in tx:
            for line in tx["lines"]:
                line["_id"] = str(line["_id"])
    
    return transactions

@api_router.get("/parties/{party_id}/balance")
async def get_party_balance(
    party_id: str,
    credentials: HTTPAuthorizationCredentials = Depends(security)
):
    """
    Calculate party balance from all completed transactions
    """
    verify_token(credentials.credentials)
    
    pipeline = [
        {
            "$match": {
                "party_id": party_id,
                "status": "COMPLETED"
            }
        },
        {
            "$group": {
                "_id": None,
                "total_has": {"$sum": "$total_has_amount"},
                "total_count": {"$sum": 1}
            }
        }
    ]
    
    result = await db.financial_transactions.aggregate(pipeline).to_list(1)
    
    if result:
        return {
            "party_id": party_id,
            "balance_has": round(result[0]["total_has"], 6),
            "transaction_count": result[0]["total_count"]
        }
    
    return {
        "party_id": party_id,
        "balance_has": 0.0,
        "transaction_count": 0
    }
```

#### AdÄ±m 3.2: Frontend PartyDetailPage'i GÃ¼ncelle

**Dosya:** `frontend/src/pages/PartyDetailPage.js`

```javascript
// Line 37-56 civarÄ±nÄ± GÃœNCELLE:

const fetchPartyDetails = async () => {
  try {
    setLoading(true);
    
    // Parallel API calls
    const [partyResponse, transactionsResponse, balanceResponse] = await Promise.all([
      axios.get(`${API}/parties/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      }),
      axios.get(`${API}/parties/${id}/transactions`, {  // â† YENÄ° ENDPOINT
        headers: { Authorization: `Bearer ${token}` }
      }),
      axios.get(`${API}/parties/${id}/balance`, {       // â† YENÄ° ENDPOINT
        headers: { Authorization: `Bearer ${token}` }
      })
    ]);
    
    console.log('ğŸ“Š Party:', partyResponse.data);
    console.log('ğŸ“Š Transactions:', transactionsResponse.data);
    console.log('ğŸ“Š Balance:', balanceResponse.data);
    
    setParty({
      ...partyResponse.data,
      balance: balanceResponse.data.balance_has,
      transaction_count: balanceResponse.data.transaction_count
    });
    
    setTransactions(transactionsResponse.data || []);
    
  } catch (error) {
    console.error('âŒ Error fetching party:', error);
    toast.error('Party yÃ¼klenemedi');
  } finally {
    setLoading(false);
  }
};
```

#### AdÄ±m 3.3: UI'da Balance ve Transactions GÃ¶ster

```javascript
{/* Balance Card */}
<Card>
  <CardHeader>
    <CardTitle>Bakiye</CardTitle>
  </CardHeader>
  <CardContent>
    <div className="flex items-center justify-between">
      <div>
        <p className="text-sm text-muted-foreground">HAS Bakiye</p>
        <p className="text-3xl font-bold">
          {formatBalance(party?.balance || 0)}
        </p>
      </div>
      <Coins className={`w-12 h-12 ${
        party?.balance > 0 ? 'text-green-500' : 
        party?.balance < 0 ? 'text-red-500' : 
        'text-gray-400'
      }`} />
    </div>
    
    <div className="mt-2 text-xs text-muted-foreground">
      {party?.balance > 0 && 'â¬†ï¸ AlacaklÄ±'}
      {party?.balance < 0 && 'â¬‡ï¸ BorÃ§lu'}
      {party?.balance === 0 && 'â¡ï¸ Dengede'}
    </div>
  </CardContent>
</Card>

{/* Transactions Tab */}
<TabsContent value="transactions">
  {transactions.length === 0 ? (
    <div className="text-center py-8 text-muted-foreground">
      HenÃ¼z iÅŸlem yok
    </div>
  ) : (
    <div className="space-y-2">
      {transactions.map((tx) => (
        <Card key={tx.code} className="cursor-pointer hover:bg-muted/50">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="font-semibold">{tx.code}</p>
                <p className="text-sm text-muted-foreground">
                  {tx.type_code} - {new Date(tx.transaction_date).toLocaleDateString('tr-TR')}
                </p>
              </div>
              <div className="text-right">
                <p className={`font-bold ${
                  tx.total_has_amount > 0 ? 'text-green-600' : 'text-red-600'
                }`}>
                  {tx.total_has_amount > 0 ? '+' : ''}
                  {formatBalance(tx.total_has_amount)} HAS
                </p>
                {tx.total_amount_currency && (
                  <p className="text-sm text-muted-foreground">
                    {tx.currency} {tx.total_amount_currency.toFixed(2)}
                  </p>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  )}
</TabsContent>
```

---

## ğŸ“ TEST PLANI

### Test 1: Combobox'lar Ã‡alÄ±ÅŸÄ±yor mu?

```
1. Hurda altÄ±n formunu aÃ§
   âœ… Party combobox'ta partiler gÃ¶rÃ¼nmeli
   âœ… Karat combobox'ta karatlar gÃ¶rÃ¼nmeli

2. AlÄ±ÅŸ formunu aÃ§
   âœ… Party combobox'ta partiler gÃ¶rÃ¼nmeli
   âœ… Para birimi combobox'ta TRY, USD, EUR gÃ¶rÃ¼nmeli
   âœ… Karat combobox'ta karatlar gÃ¶rÃ¼nmeli

3. Party edit
   âœ… Party tipi combobox'ta 7 tip gÃ¶rÃ¼nmeli
```

### Test 2: Hurda AltÄ±n ile Ã–deme

```
1. Yeni Ã¶deme â†’ Ã–deme yÃ¶ntemi: Hurda AltÄ±n
   âœ… Hurda altÄ±n detaylarÄ± bÃ¶lÃ¼mÃ¼ aÃ§Ä±lmalÄ±
   
2. Hurda bilgilerini gir:
   - Karat: 22K
   - AÄŸÄ±rlÄ±k: 10 gram
   âœ… HAS karÅŸÄ±lÄ±ÄŸÄ± hesaplanmalÄ± (10 Ã— 0.916 = 9.16 HAS)
   âœ… TL karÅŸÄ±lÄ±ÄŸÄ± gÃ¶sterilmeli
   
3. Kaydet
   âœ… Transaction oluÅŸmalÄ±
   âœ… Backend'de lines iÃ§inde hurda detaylarÄ± olmalÄ±
```

### Test 3: Party Balance

```
1. Yeni party oluÅŸtur
   âœ… Party oluÅŸmalÄ±

2. Bu party'ye satÄ±ÅŸ yap (Ã¶rn: 100 HAS)
   âœ… Transaction oluÅŸmalÄ±
   
3. Party detay sayfasÄ±na git
   âœ… Balance: +100 HAS gÃ¶rÃ¼nmeli
   âœ… Ä°ÅŸlemler tabÄ±nda satÄ±ÅŸ gÃ¶rÃ¼nmeli
   
4. Bu party'den tahsilat al (Ã¶rn: 50 HAS)
   âœ… Balance: +50 HAS olmalÄ± (100 - 50)
   âœ… Ä°ÅŸlemler tabÄ±nda tahsilat gÃ¶rÃ¼nmeli
```

---

## ğŸ¯ Ã–NCELÄ°K SIRASI (EMERGENT AI Ä°Ã‡Ä°N)

### Hafta 1 - Kritik Sorunlar

#### GÃ¼n 1: Combobox'larÄ± DÃ¼zelt (En Kritik)
- â±ï¸ SÃ¼re: 3-4 saat
- ğŸ¯ Hedef: TÃ¼m combobox'lar Ã§alÄ±ÅŸsÄ±n
- âœ… BaÅŸarÄ±: Formlar kullanÄ±labilir olsun

#### GÃ¼n 2: Party Balance ve Ä°ÅŸlemler
- â±ï¸ SÃ¼re: 3-4 saat
- ğŸ¯ Hedef: Party detayÄ±nda balance ve iÅŸlemler gÃ¶rsÃ¼n
- âœ… BaÅŸarÄ±: MÃ¼ÅŸteri borÃ§/alacaÄŸÄ± takip edilsin

#### GÃ¼n 3: Hurda AltÄ±n ile Ã–deme
- â±ï¸ SÃ¼re: 4-5 saat
- ğŸ¯ Hedef: Hurda altÄ±n ile Ã¶deme yapÄ±labilsin
- âœ… BaÅŸarÄ±: Sarrafiye'ye hurda ile Ã¶deme senaryosu Ã§alÄ±ÅŸsÄ±n

---

## ğŸ’¡ EMERGENT AI Ä°Ã‡Ä°N SON NOTLAR

### YaklaÅŸÄ±m Stratejisi
1. **Ä°lk olarak:** Combobox sorununu Ã§Ã¶z (en basit ve en kritik)
2. **Console log kullan:** Her adÄ±mda debug yap
3. **Tek seferde bir form:** HurdaForm â†’ PurchaseForm â†’ PaymentForm
4. **Test et:** Her deÄŸiÅŸiklikten sonra test et

### Dikkat Edilecekler
1. âŒ **DOKUNMA:** Backend transaction create logic'e (Ã§alÄ±ÅŸÄ±yor)
2. âŒ **DOKUNMA:** HAS calculation helper'larÄ±na (doÄŸru)
3. âœ… **DEÄER:** Sadece broken combobox'larÄ± ve eksik UI'larÄ± dÃ¼zelt

### Debug Checklist
- [ ] Console'da API request gÃ¶rÃ¼nÃ¼yor mu?
- [ ] API response 200 OK mi?
- [ ] Response data boÅŸ deÄŸil mi?
- [ ] State'e veri geliyor mu? (React DevTools)
- [ ] Combobox items render ediliyor mu?
- [ ] Value type string/integer uyuÅŸuyor mu?

---

**SONUÃ‡:** TÃ¼m sorunlar Ã§Ã¶zÃ¼lebilir! En kritik olanÄ± combobox sorunu. Onu Ã§Ã¶zÃ¼nce geri kalanÄ± takip eder.
